# 图解计算机网络

## 1、基础篇

### 1.1、TCP/IP网络模型
> Q：为什么要有网络模型？
> 
> A：由于不同设备之间通信的方式不同，为了兼容各式各样的设备，诞生了一套通用的网络协议。

#### 1.1.1、应用层
- 数据封装格式
  - 应用数据
- 数据单位
  - 消息或报文（message）
- 应用层是最上面一层，也是我们能够直接接触到的就是应用层（Application layer）
- 应用层只需要专注于为用户提供应用功能，比如 HTTP、FTP、Telnet、DNS、SMTP等。
- 应用层不需要去关注数据传输的细节，就类似于寄快递，只需要知道快递公司的名字就可以了，不需要知道快递公司的运输细节。

#### 1.1.2、传输层
- 应用层的数据会传递给传输层（Transport layer），传输层为应用层提供网络支持的。
- 数据封装格式
  - TCP头部 + 应用数据
- 数据单位
  - 段（segment）
- 传输层协议
  - TCP
    - TCP全称传输控制协议（Transmission Control Protocol）是一种面向连接的、可靠的、基于字节流的传输层通信协议。
    - 在应用层中HTTP使用的就是TCP协议
    - **TCP特性**（为了保证数据包能可靠地传输给对方）
      - 流量控制
      - 拥塞控制
      - 超时重传
  - UDP
    - UDP全称用户数据报协议（User Datagram Protocol）是一种面向无连接的传输层通信协议。
    - 简单到只负责发送数据包，不保证数据包是否能抵达对方，但它实时性相对更好，传输效率也高。
#### 1.1.3、网络层
- 网络层（Network layer）主要负责为数据包选择路由（Routing）。
- 数据封装格式
  - IP头部 + TCP头部 + 应用数据
- 数据单位
  - 包（package）
- 网络层最常用的协议是IP协议
  - IP 协议
    - 会将传输层的报文作为数据部分，再加上 IP 包头组装成 IP 报文，如果 IP 报文大小超过 MTU（以太网中一般为 1500 字节）就会再次进行分片，得到一个即将发送到网络的 IP 报文。
    - 寻址
      - 告诉去往下一个目的地的该往那个方向走
    - 路由
      - 根据「下一个目的地」选择路径


#### 1.1.4、网络接口层
- 网络接口层（Network Interface layer）负责处理与物理层的数据通信，也就是说它负责处理与电缆（光纤）、网卡的数据通信。
- 经过网络层生成了 IP 头部之后，接下来要交给网络接口层（Link Layer）在 IP 头部的前面加上 MAC 头部，并封装成数据帧（Data frame）发送到网络上。
- 数据封装格式
  - 帧头 + IP头部 + TCP头部 + 应用数据 + 帧尾
- 数据单位
  - 帧（frame）

### 1.2、键入网址到网站显示，期间发生了什么？

#### 1.2.1、HTTP

> 1、浏览器第一步做的工作就是解析URL

- 解析URL
  - http: + // +  Web服务器 + / + 路径 + 文件名 
- 生成发送给Web服务器的请求信息
  - 请求报文
    - 请求行
      - 请求方法 + URL + HTTP版本
    - 消息头
      - 请求首部 + 字段值
    - 消息体
      - 数据
  - 响应报文
    - 状态行
      - HTTP版本 + 状态码 + 状态码描述
    - 消息头
      - 响应首部 + 字段值
    - 消息体
      - 数据
> 2、真实地址查询 => DNS

- 浏览器通过解析URL生成HTTP请求之后，需要查询服务器域名对应的ip地址，才能成功将数据发送到服务器上

> 3、通过DNS获取到真实ip地址之后，将HTTP传输的工作交给协议栈，这个节点产生数据包


> 4、数据包交由TCP协议进行传输（可靠传输 ）
- TCP传输数据之前，要先经过三次握手建立链接
  - 流程
    - 第一次握手
      - 客户端发送一个SYN包给服务器，请求建立连接
    - 第二次握手
      - 服务器收到SYN包之后，回复一个SYN+ACK包给客户端
    - 第三次握手
      - 客户端收到SYN+ACK包之后，回复一个ACK包给服务器，服务器收到ACK包之后，连接建立成功
  - 目的
    - 保证双方都有发送和接收数据的能力
> 5、TCP协议传输数据包之后，交给IP协议进行传输（寻址和路由）

- TCP在各种操作的时候，都需要IP协议来进行寻址&路由，以便将数据（网络包）成功的发送给通信对象
- 地址
  - 源地址IP，即是客户端输出的 IP 地址 
  - 目标地址，即通过 DNS 域名解析得到的 Web服务器IP地址

> 6、生成了 IP 头部之后，接下来网络包还需要在 IP 头部的前面加上 MAC 头部


> 7、最终将数据通过网卡将数据转换成电信号在网络上传输

## 2、HTTP篇

### 2.1、HTTP 基本概念
- HTTP 是超文本传输协议，也就是HyperText Transfer Protocol。
  - 组成
    - 超文本
    - 传输
      - HTTP是一个双向的协议
      - HTTP是专门用来在A点和B点传输超文本数据的行为约定和规范
    - 协议
      - HTTP 是一个用在计算机世界里的**协议**。
      - 它使用计算机能够理解的语言确立了一种计算机之间交流通信的规范（两个以上的参与者）
      - 以及相关的各种控制和错误处理方式（**行为约定和规范**）
  - 总结
    - **HTTP** 是一个在计算机世界里专门在「**两点**」之间「**传输**」文字、图片、音频、视频等「**超文本**」数据的「**约定和规范**」
- **HTTP常见状态码**
  - 1xx
    - 指示信息--表示请求已接收，继续处理
  - 2xx
    - 成功--表示请求已被成功接收、理解、接受
  - 3xx
    - 重定向--要完成请求必须进行更进一步的操作
  - 4xx
    - 客户端错误--请求有语法错误或请求无法实现
  - 5xx
    - 服务器端错误--服务器未能实现合法的请求
- HTTP常见字段有哪些？
  - HOST
    - 客户端发送请求时，用来指定服务器的域名。
    - Host: www.A.com
  - Content-Length
    - 服务器在**返回数据**时，会有 Content-Length 字段，表明本次响应的数据长度。
    - Content-Length: 1000
  - Connection
    - Connection 字段用来告诉服务器，本次请求完毕后，是否关闭网络连接。  
    - 该字段用于客户端要求服务器使用「HTTP 长连接」机制，以便其他请求复用
    - HTTP 1.1默认开启长链接，老版本需要通过**Connection: Keep-Alive**参数来开启长链接
  - Content-Type
    - Content-Type 字段用来告诉服务器，本次请求发送的数据类型。
    - eg
      - Content-Type: application/json
      - Content-Type: text/html; Charset=utf-8
  - Content-Encoding
    - Content-Encoding 字段用来告诉服务器，本次请求发送的数据压缩方式。
    - eg
      - Content-Encoding: gzip
### 2.2、Get 与 Post区别
- 自我理解
  - Get
    - 用于获取数据
    - Get语义是从服务器获取指定的资源
    - 浏览器会对URL长度进行限制
  - Post
    - 用于提交数据
    - POST 的语义是根据请求负荷（报文body）对指定的资源做出处理
    - 浏览器不会对POST请求中的body大小做限制

### 2.3、HTTP 特性
- Get
  - 幂等性
  - 服务器上的数据资源都是安全的
  - 数据可缓存
- Post
  - 无幂等性
  - 客户端提交的数据都是不安全不稳定的
  - 数据不可缓存
### 2.4、HTTP 缓存技术
- 概念
  - 对于一些重复性的HTTP请求，将这对[请求、响应]数据缓存在本地
  - 避免发送 HTTP 请求的方法就是通过缓存技术
- 强制缓存
  - 强缓存指的是只要浏览器判断缓存没有过期，则直接使用浏览器的本地缓存，决定是否使用缓存的主动性在于浏览器这边
- 协商缓存
  - 当发送请求时响应状态码位304时，这时候服务器是在告知客户端该数据是可以使用本地的缓存数据

### 2.5、HTTPS 与 HTTP
- HTTPS在原先的HTTP和TCP中间添加了TSL/SSL协议，使得数据在原本http明文传输的状态下更加安全可靠
### 2.6、HTTP/1.1、HTTP/2、HTTP/3 演变
- HTTP1.1 相比较于HTTP1.0的优点
  - 是用了长连接改善了HTTP1.0  短连接的性能开销
  - 支持管道（pipeline）网络传输
    - 只要第一个请求发出去了，不必等其回来，就可以发第二个请求出去，可以减少整体的响应时间
- HTTP 1.1 缺点
  - 请求是按照顺序响应的，服务器响应越慢，会招致客户端一直请求不到数据，也就是**队头阻塞**；
  - 没有请求优先级控制
  - 请求只能从客户端开始，服务器只能被动响应
  - 请求 / 响应头部（Header）未经压缩就发送，首部信息越多延迟越大。只能压缩 Body 的部分
  - 发送冗长的首部。每次互相发送相同的首部造成的浪费较多
### 2.7、HTTP/1.1如何优化
- 尽量避免发送HTTP请求
  - 缓存
    - 对于每次请求到的数据都是一样的请求，可以将这对【请求-响应】缓存在本地
- 在需要发送HTTP请求时，考虑如何减少请求次数
  - 减少重定向请求次数
  - 合并请求
  - 延迟发送请求
- 减少服务器的HTTP响应的数据大小
  - 无损压缩
  - 有损压缩

## 3、TCP
### 3.1、为什么是三次握手？
- TCP使用三次握手建立连接的最主要原因是防止【历史连接】初始化了连接，避免浪费服务端的资源
- 同步双方初始序列号
- 避免资源浪费

### 3.2、TCP四次挥手过程
- 